# modules/prompt_generator.py
import json
import random
from typing import Dict
from config import Config

class PromptGenerator:
    """Генератор промптов для модели с явным указанием метки"""
    
    def __init__(self, config: Config):
        self.config = config
        
        self.system_prompt = """Ты - генератор синтетических отзывов, жалоб и комментариев для обучения классификатора тональности текста.
Твоя задача - создавать короткие (30-150 слов) тексты в стиле пользовательских отзывов, жалоб или нейтральных сообщений.

ТЕМАТИКИ: транспорт, услуги, товары, сервисы, общепит, развлечения, медицина, образование, бытовые услуги.

СТИЛИ СООБЩЕНИЙ:
- POSITIVE: положительный опыт, благодарность, похвала, рекомендация
- NEGATIVE: негативный опыт, жалоба, критика, требование решения
- NEUTRAL: вопрос, уточнение, информационное сообщение, запрос

Ты всегда возвращаешь ТОЛЬКО JSON объект с полями 'text' и 'label'.
Label должен точно соответствовать запрошенной метке!"""
    
    def generate_prompt_with_label(self, label: str) -> str:
        """Генерирует промпт с явным указанием метки"""
        context = self.config.get_random_context()
        
        # Определяем тему в зависимости от метки
        if label == "positive":
            topics = [
                "отличный сервис", "качественное обслуживание", "быстрая доставка",
                "вежливый персонал", "чистота и порядок", "вкусная еда",
                "комфортные условия", "профессионализм сотрудников", "хорошее соотношение цены и качества"
            ]
            scenario = random.choice([
                "благодарность за отличную работу",
                "рекомендация услуги/товара",
                "похвала сотруднику",
                "положительный отзыв о покупке"
            ])
            emotion = random.choice(["радостный", "довольный", "восторженный", "благодарный"])
            
        elif label == "negative":
            topics = [
                "проблемы с обслуживанием", "некачественный товар", "опоздание доставки",
                "грубость персонала", "грязь и беспорядок", "неправильный заказ",
                "поломка товара", "обман клиента", "завышенные цены"
            ]
            scenario = random.choice([
                "жалоба на некачественный товар",
                "претензия по обслуживанию",
                "критика работы сотрудника",
                "требование возврата денег"
            ])
            emotion = random.choice(["сердитый", "разочарованный", "возмущенный", "недовольный"])
            
        else:  # neutral
            topics = [
                "уточнение информации", "вопрос о графике работы", "запрос документов",
                "информационное сообщение", "подтверждение заказа", "статус выполнения"
            ]
            scenario = random.choice([
                "вопрос о наличии товара",
                "уточнение деталей услуги",
                "запрос информации",
                "подтверждение данных"
            ])
            emotion = random.choice(["нейтральный", "спокойный", "любопытный", "деловой"])
        
        # Выбираем конкретную тему
        topic = random.choice(topics)
        
        # Определяем детали в зависимости от темы
        details = self._get_topic_details(topic, label)
        
        prompt = f"""{self.system_prompt}

ЗАДАНИЕ:
Сгенерируй текст с меткой: {label.upper()}

КОНТЕКСТ:
• Тема: {topic}
• Сценарий: {scenario}
• Отрасль: {context['industry']}
• Профессия автора: {context['profession']}
• Эмоциональный тон: {emotion}
• Стиль письма: {context['style']}
• Детали: {details}

ТРЕБОВАНИЯ:
1. Текст должен быть реалистичным, как будто его написал реальный человек
2. Длина: 30-55 слов не больше
3. Стиль: естественный, неискусственный
4. Метка должна быть точно: {label}

ПРИМЕРЫ:

Для POSITIVE:
{{
  "text": "Заказывали суши сет на компанию в 'Суши Wok'. Привезли всё вовремя, упаковано идеально, соевый соус и имбирь положили с запасом. Все остались сыты и довольны!",
  "label": "positive"
}}

Для NEGATIVE:
{{
  "text": "Добрый день! 29.11.2023 в 07:08, водитель маршрутки №45 не открыл дверь на остановке в Верхних Печëрах по требованию. Примите меры, пожалуйста.",
  "label": "negative"
}}

Для NEUTRAL:
{{
  "text": "Подскажите, пожалуйста, до скольки работает ваша аптека в субботу? И есть ли в наличии лекарство 'Нурофен'?",
  "label": "neutral"
}}

Твой ответ (ТОЛЬКО JSON):"""
        
        return prompt
    
    def _get_topic_details(self, topic: str, label: str) -> str:
        """Генерирует детали для темы"""
        details = ""
        
        if "транспорт" in topic.lower() or "водитель" in topic.lower():
            if label == "negative":
                details = random.choice([
                    "водитель был грубый, не останавливался на остановках, превышал скорость",
                    "автобус пришел с опозданием 30 минут, в салоне было грязно",
                    "кондуктор неправильно дал сдачу, отказался пересчитывать"
                ])
            elif label == "positive":
                details = random.choice([
                    "водитель был вежливый, помог с багажом, вовремя объявлял остановки",
                    "автобус пришел точно по расписанию, в салоне чисто и комфортно",
                    "кондуктор вежливо общался, правильно дал сдачу"
                ])
            else:
                details = random.choice([
                    "нужно узнать расписание автобуса №45 на завтра",
                    "интересует стоимость проезда до центра города",
                    "уточняю, есть ли льготный проезд для студентов"
                ])
        
        elif "кафе" in topic.lower() or "ресторан" in topic.lower():
            if label == "negative":
                details = random.choice([
                    "еда пришла холодная, официант забыл про нас, ждали 40 минут",
                    "в супе был волос, администратор отказался заменить блюдо",
                    "заказали пиццу, принесли не ту, что заказывали"
                ])
            elif label == "positive":
                details = random.choice([
                    "еда была вкусная и горячая, обслуживание быстрое, атмосфера приятная",
                    "официант был внимательный, помог с выбором блюд, всё понравилось",
                    "заказывали торт на день рождения - сделали красиво и вкусно"
                ])
            else:
                details = random.choice([
                    "интересует, есть ли столик на 4 человека на субботу в 19:00",
                    "уточняю состав салата 'Цезарь' в вашем меню",
                    "нужно узнать, возможна ли доставка еды в наш офис"
                ])
        
        else:
            details = "обычная ситуация из жизни"
        
        return details