# modules/prompt_generator.py
import json
import random
from typing import Dict
from config import Config

class PromptGenerator:
    """Генератор промптов для создания реальных интернет-комментариев"""
    
    def __init__(self, config: Config):
        self.config = config
        
        # РЕАЛЬНЫЕ примеры комментариев (как пишут люди на самом деле)
        self.REAL_EXAMPLES = {
            "positive": [
                "лол умер со смеху",
                "зашло норм",
                "ого прикол",
                "автор красава",
                "на 5:20 угар",
                "сохранил себе",
                "уже пятый раз смотрю",
                "жиза прям в точку",
                "бомба просто",
                "чувак ты гений",
                "ржу не могу",
                "огонь как всегда",
                "норм тема",
                "харош",
                "угарно",
                "прикольно вышло",
                "смешно до слёз",
                "топчик",
                "круто получилось",
                "мне зашло"
            ],
            "negative": [
                "скучно чел",
                "звук говно",
                "не зашло",
                "фу такое",
                "дичь какая",
                "монтаж кривой",
                "ожидал большего",
                "ну такое",
                "не смешно",
                "звук ужас",
                "видео говно",
                "слабовато",
                "не понял",
                "зачем это",
                "скучняк",
                "не оч",
                "мимо",
                "не моё",
                "разочарован",
                "бесит"
            ],
            "neutral": [
                "а где ссылка",
                "что за игра",
                "на какой минуте",
                "кто это вообще",
                "а можно подробнее",
                "а это точно работает",
                "сколько стоит",
                "а кто автор",
                "где снималось",
                "что за песня",
                "а есть ещё",
                "как называется",
                "а почему так",
                "когда выйдет",
                "а это где",
                "сколько времени",
                "какой софт",
                "а зачем это",
                "что за приложение",
                "а можно ссылку"
            ]
        }
        
        self.system_prompt = """Ты пишешь реальные комментарии под видео в интернете.
Пиши КАК ОБЫЧНЫЙ ЧЕЛОВЕК, который смотрит видео и пишет быстрый комментарий.

ПРАВИЛА:
1. КОРОТКО: 1-2 предложения (10-20 слов)
2. ПРОСТО: обычный разговорный язык
3. БЫСТРО: как пишешь в чате другу
4. БЕЗ ЭМОДЗИ: только текст
5. БЕЗ СТАРАНИЯ БЫТЬ КРУТЫМ: пиши естественно

Ты всегда возвращаешь ТОЛЬКО JSON объект с полями 'text' и 'label'."""

    def generate_prompt_with_label(self, label: str) -> str:
        """Генерирует промпт с явным указанием метки"""
        
        platform = self.config.get_random_platform()
        topic = self.config.get_random_topic()
        
        # Выбираем 3 реальных примера для вдохновения
        real_examples = random.sample(self.REAL_EXAMPLES[label], 3)
        
        # Описание настроения
        moods = {
            "positive": ["доволен", "смеется", "удивлен", "восхищен", "рад"],
            "negative": ["недоволен", "скучает", "разочарован", "раздражен", "злится"],
            "neutral": ["спрашивает", "уточняет", "интересуется", "констатирует", "сомневается"]
        }
        mood = random.choice(moods[label])
        
        # Совет по стилю
        style_tips = [
            "можно с маленькой буквы",
            "допусти опечатки",
            "без точек в конце",
            "пиши как в смс",
            "сокращай слова",
            "не парься над грамматикой"
        ]
        tip = random.choice(style_tips)
        
        prompt = f"""{self.system_prompt}

ЗАДАНИЕ:
Напиши один комментарий под видео.

ПАРАМЕТРЫ:
• Видео про: {topic}
• Платформа: {platform}
• Настроение: {mood}
• Метка: {label}
• Совет: {tip}

КАК НАДО ПИСАТЬ (реальные примеры):
{chr(10).join(f'• "{example}"' for example in real_examples)}

КАК НЕ НАДО ПИСАТЬ (слишком накручено):
• "Вау, это просто невероятно, братан!"
• "Ох, какое же это криповое видео!"
• "Это просто имбовый контент, дружище!"
• "Я в полном восторге от данного видеоролика!"

ПОМНИ:
• Пишешь быстро, не задумываясь
• Простые слова, простые мысли
• Как будто пишешь в чат с другом
• Не пытайся быть умным или смешным

ТЕМЫ ВИДЕО (для контекста):
• игры, стримы, летсплеи
• мемы, приколы, юмор
• обзоры техники
• музыка, клипы
• лайфхаки, советы
• новости, сплетни

Напиши ОДИН реальный комментарий:

{{
  "text": "твой_комментарий",
  "label": "{label}"
}}"""
        
        return prompt
    
    def generate_batch_prompt(self, count: int = 15) -> str:
        """Генерация нескольких комментариев"""
        
        # Распределение
        pos = int(count * 0.4)
        neg = int(count * 0.4)
        neu = count - pos - neg
        
        # Выбираем примеры каждого типа
        pos_examples = random.sample(self.REAL_EXAMPLES["positive"], 5)
        neg_examples = random.sample(self.REAL_EXAMPLES["negative"], 5)
        neu_examples = random.sample(self.REAL_EXAMPLES["neutral"], 5)
        
        # Темы для видео
        topics = random.sample(self.config.content_topics, 8)
        
        prompt = f"""{self.system_prompt}

ЗАДАНИЕ:
Напиши {count} разных комментариев под видео на YouTube/TikTok.

РАСПРЕДЕЛЕНИЕ:
• {pos} позитивных
• {neg} негативных  
• {neu} нейтральных

РЕАЛЬНЫЕ ПРИМЕРЫ ДЛЯ ВДОХНОВЛЕНИЯ:
Позитивные: {", ".join(f'"{e}"' for e in pos_examples)}
Негативные: {", ".join(f'"{e}"' for e in neg_examples)}
Нейтральные: {", ".join(f'"{e}"' for e in neu_examples)}

ТЕМЫ ВИДЕО:
{chr(10).join(f'• {topic}' for topic in topics)}

ВАЖНЫЕ ПРАВИЛА:
1. КОРОТКО: каждый комментарий 3-15 слов
2. ЕСТЕСТВЕННО: как реальный человек, а не бот
3. РАЗНЫЕ: разные стили, разные темы
4. ОШИБКИ ОК: опечатки, без пунктуации - это нормально

ПЛОХИЕ ПРИМЕРЫ (так не надо):
• "Это видео просто великолепно!"
• "Я разочарован качеством контента"
• "Могли бы вы предоставить дополнительную информацию?"

ХОРОШИЕ ПРИМЕРЫ (так надо):
• "норм видос"
• "скучно чел"
• "а где ссылка"
• "ого прикол"
• "звук плохой"

СОВЕТЫ:
• Пиши с маленькой буквы
• Без точек в конце
• Допусти пару опечаток
• Используй обычный сленг, но не перегружай
• Не пытайся быть слишком умным или смешным

Напиши {count} комментариев:

[
  {{"text": "коммент 1", "label": "positive"}},
  {{"text": "коммент 2", "label": "negative"}},
  ...
]"""
        
        return prompt
    
    def generate_challenge_prompt(self, challenge_type: str = "sarcasm") -> str:
        """Генерация сложных случаев (сарказм и т.д.)"""
        
        challenges = {
            "sarcasm": {
                "description": "Саркастичные комментарии (выглядят как позитивные, но негативные)",
                "examples": [
                    "ну да конечно просто гениально",
                    "спасибо что потратил мое время",
                    "ого какой полезный совет",
                    "да да очень смешно",
                    "просто прекрасно продолжай",
                    "лучшее что я видел за год смех",
                    "вау такому надо оскар давать",
                    "обязательно попробую никогда"
                ],
                "true_label": "negative"
            },
            "short": {
                "description": "Очень короткие комментарии (2-5 слов)",
                "examples": [
                    "норм",
                    "не оч",
                    "а ссылка",
                    "скучно",
                    "зашло",
                    "ого",
                    "фу",
                    "ок"
                ],
                "true_label": "random"  # Может быть любой
            },
            "question": {
                "description": "Вопросы, которые содержат оценку",
                "examples": [
                    "а это вообще кто",
                    "зачем это было нужно",
                    "это про что вообще",
                    "а где контент то",
                    "что за монтаж такой",
                    "почему так тихо",
                    "когда уже нормально будет"
                ],
                "true_label": "negative"  # Чаще негативные
            }
        }
        
        if challenge_type not in challenges:
            challenge_type = "sarcasm"
        
        challenge = challenges[challenge_type]
        examples = challenge["examples"]
        label = challenge["true_label"]
        if label == "random":
            label = random.choice(["positive", "negative", "neutral"])
        
        prompt = f"""{self.system_prompt}

ОСОБОЕ ЗАДАНИЕ: {challenge["description"]}

Примеры таких комментариев:
{chr(10).join(f'• "{example}"' for example in examples)}

Настоящая метка: {label}

НАПОМИНАНИЕ:
• Коротко и по делу
• Естественно, как человек
• Без лишних слов

Сгенерируй 5 таких комментариев:

[
  {{"text": "коммент 1", "label": "{label}"}},
  {{"text": "коммент 2", "label": "{label}"}},
  ...
]"""
        
        return prompt